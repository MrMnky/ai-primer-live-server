<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compose Course ‚Äî AI Primer Live</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #111;
      color: #fff;
      font-family: var(--font-family, 'Poppins', sans-serif);
      overflow: hidden;
    }

    .compose-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ‚îÄ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ‚îÄ */
    .compose-top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      gap: 16px;
    }

    .compose-top-bar__left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 120px;
    }

    /* ‚îÄ‚îÄ‚îÄ App Nav ‚îÄ‚îÄ‚îÄ */
    .app-nav {
      display: flex;
      align-items: center;
      padding: 0 24px;
      height: 48px;
      background: rgba(27, 47, 60, 0.6);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      gap: 24px;
      flex-shrink: 0;
    }
    .app-nav__logo img { height: 22px; opacity: 0.7; }
    .app-nav__links {
      display: flex;
      gap: 4px;
      list-style: none;
      margin: 0; padding: 0;
    }
    .app-nav__links a {
      color: rgba(255, 255, 255, 0.5);
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      padding: 6px 14px;
      border-radius: 6px;
      transition: all 0.15s;
    }
    .app-nav__links a:hover { color: #fff; background: rgba(255,255,255,0.06); }
    .app-nav__links a.active { color: #fff; background: rgba(0, 177, 255, 0.15); }

    .compose-top-bar__center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .compose-title-input {
      background: transparent;
      border: 1px solid transparent;
      color: #fff;
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 1.4rem;
      font-weight: 600;
      text-align: center;
      padding: 8px 16px;
      border-radius: 6px;
      max-width: 400px;
      transition: all 0.15s;
    }

    .compose-title-input:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .compose-title-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--bright-turquoise, #00FFBC);
    }

    .compose-top-bar__right {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 180px;
      justify-content: flex-end;
    }

    .compose-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }

    .compose-badge__count {
      color: var(--bright-turquoise, #00FFBC);
      font-weight: 600;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn--primary {
      background: var(--bright-turquoise, #00FFBC);
      color: #1B2F3C;
    }

    .btn--primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn--primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn--secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn--secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .btn--small {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    /* ‚îÄ‚îÄ‚îÄ Main Layout (two-panel) ‚îÄ‚îÄ‚îÄ */
    .compose-main {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }

    /* ‚îÄ‚îÄ‚îÄ Left Panel: Slide Library ‚îÄ‚îÄ‚îÄ */
    .compose-library {
      width: 40%;
      background: #0a0a0a;
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .compose-library__header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    .compose-library__title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .compose-library__search {
      position: relative;
    }

    .compose-library__search input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #fff;
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .compose-library__search input:focus {
      outline: none;
      border-color: var(--bright-turquoise, #00FFBC);
      background: rgba(255, 255, 255, 0.08);
    }

    .compose-library__search::before {
      content: 'üîç';
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      opacity: 0.5;
    }

    .compose-library__content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .compose-section {
      margin-bottom: 8px;
    }

    .compose-section__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }

    .compose-section__header:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .compose-section__header--collapsed {
      background: rgba(255, 255, 255, 0.02);
    }

    .compose-section__title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .compose-section__toggle {
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 1;
      text-align: center;
      opacity: 0.5;
      transition: transform 0.15s;
      font-size: 0.7rem;
    }

    .compose-section__toggle.open {
      transform: rotate(90deg);
    }

    .compose-section__count {
      font-size: 0.8rem;
      opacity: 0.6;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .compose-section__slides {
      display: none;
      margin-top: 4px;
      padding: 4px 0;
    }

    .compose-section__slides.open {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .compose-slide-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid transparent;
      border-radius: 6px;
      transition: all 0.15s;
      cursor: pointer;
    }

    .compose-slide-row:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .compose-slide-row__checkbox {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .compose-slide-row__title {
      flex: 1;
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .compose-slide-row__badge {
      flex-shrink: 0;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Type badge colours */
    .compose-slide-row__badge.content,
    .compose-slide-row__badge.statement {
      background: rgba(128, 128, 128, 0.2);
      color: #999;
      border-color: rgba(128, 128, 128, 0.3);
    }

    .compose-slide-row__badge.quiz {
      background: rgba(255, 215, 0, 0.15);
      color: #FFD700;
      border-color: rgba(255, 215, 0, 0.3);
    }

    .compose-slide-row__badge.poll {
      background: rgba(0, 177, 255, 0.15);
      color: #00B1FF;
      border-color: rgba(0, 177, 255, 0.3);
    }

    .compose-slide-row__badge.text-input {
      background: rgba(255, 105, 180, 0.15);
      color: #FF69B4;
      border-color: rgba(255, 105, 180, 0.3);
    }

    .compose-slide-row__badge.graphic {
      background: rgba(0, 255, 188, 0.15);
      color: #00FFBC;
      border-color: rgba(0, 255, 188, 0.3);
    }

    .compose-slide-row__badge.video,
    .compose-slide-row__badge.full-media {
      background: rgba(155, 89, 182, 0.15);
      color: #9B59B6;
      border-color: rgba(155, 89, 182, 0.3);
    }

    .compose-slide-row__badge.results {
      background: rgba(230, 126, 34, 0.15);
      color: #E67E22;
      border-color: rgba(230, 126, 34, 0.3);
    }

    .compose-slide-row__badge.section,
    .compose-slide-row__badge.cover {
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .compose-section-actions {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: rgba(255, 255, 255, 0.01);
      border-radius: 6px;
      margin-top: 8px;
    }

    .compose-section-actions button {
      flex: 1;
      font-size: 0.75rem;
    }

    /* ‚îÄ‚îÄ‚îÄ Right Panel: Course Builder ‚îÄ‚îÄ‚îÄ */
    .compose-builder {
      width: 60%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .compose-builder__header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    .compose-builder__title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .compose-builder__stats {
      font-size: 0.8rem;
      opacity: 0.6;
    }

    .compose-builder__content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .compose-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      opacity: 0.4;
    }

    .compose-empty-state p {
      font-size: 0.95rem;
      margin-top: 8px;
    }

    .compose-course-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .compose-course-slide {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      transition: all 0.15s;
      cursor: grab;
      user-select: none;
    }

    .compose-course-slide:active {
      cursor: grabbing;
    }

    .compose-course-slide.dragging {
      opacity: 0.5;
      background: rgba(255, 255, 255, 0.02);
    }

    .compose-course-slide.drag-over {
      background: rgba(0, 255, 188, 0.1);
      border-color: var(--bright-turquoise, #00FFBC);
    }

    .compose-course-slide__drag-handle {
      flex-shrink: 0;
      color: rgba(255, 255, 255, 0.3);
      font-size: 0.9rem;
      cursor: grab;
    }

    .compose-course-slide__drag-handle:active {
      cursor: grabbing;
    }

    .compose-course-slide__number {
      flex-shrink: 0;
      width: 28px;
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      opacity: 0.6;
    }

    .compose-course-slide__title {
      flex: 1;
      font-size: 0.85rem;
    }

    .compose-course-slide__badge {
      flex-shrink: 0;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .compose-course-slide__edited {
      flex-shrink: 0;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--bright-turquoise, #00FFBC);
    }

    .compose-course-slide__actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .compose-course-slide__btn {
      width: 28px;
      height: 28px;
      padding: 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: #fff;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .compose-course-slide__btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .compose-section-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: rgba(0, 255, 188, 0.05);
      border: 1px dashed rgba(0, 255, 188, 0.3);
      border-radius: 6px;
      margin: 4px 0;
    }

    .compose-section-divider__icon {
      flex-shrink: 0;
      color: var(--bright-turquoise, #00FFBC);
      font-size: 0.85rem;
    }

    .compose-section-divider__label {
      flex: 1;
      font-size: 0.85rem;
      padding: 4px 8px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: #fff;
      font-family: var(--font-family, 'Poppins', sans-serif);
    }

    .compose-section-divider__label:focus {
      outline: none;
      border-color: var(--bright-turquoise, #00FFBC);
    }

    .compose-section-divider__delete {
      width: 24px;
      height: 24px;
      padding: 0;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.15s;
    }

    .compose-section-divider__delete:hover {
      background: rgba(255, 68, 68, 0.3);
      color: #FF4444;
    }

    .compose-builder__footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    .compose-footer-actions {
      display: flex;
      gap: 10px;
    }

    .compose-footer-actions .compose-add-divider {
      flex: 1;
    }

    .compose-new-slide-wrapper {
      position: relative;
      flex: 1;
    }

    .compose-new-slide-btn {
      width: 100%;
    }

    .compose-template-picker {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      right: 0;
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 8px;
      z-index: 100;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      max-height: 420px;
      overflow-y: auto;
    }

    .compose-template-picker.open {
      display: block;
    }

    .compose-template-picker__header {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.4);
      padding: 6px 10px 8px;
      font-weight: 600;
    }

    .compose-template-option {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      transition: background 0.12s;
    }

    .compose-template-option:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .compose-template-option__icon {
      font-size: 1.3rem;
      width: 32px;
      text-align: center;
      flex-shrink: 0;
    }

    .compose-template-option__info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .compose-template-option__info strong {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .compose-template-option__info small {
      font-size: 0.72rem;
      color: rgba(255, 255, 255, 0.45);
    }

    /* Custom slide badge in course list */
    .compose-course-slide__custom-badge {
      font-size: 0.6rem;
      color: var(--bright-turquoise, #00FFBC);
      background: rgba(0, 255, 188, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    /* ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ */
    .compose-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-y: auto;
    }

    .compose-modal.open {
      display: flex;
    }

    .compose-modal__content {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      display: flex;
      flex-direction: column;
    }

    .compose-modal__header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: rgba(255, 255, 255, 0.02);
    }

    .compose-modal__title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .compose-modal__badge {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      opacity: 0.8;
    }

    .compose-modal__id {
      font-size: 0.8rem;
      opacity: 0.5;
      font-family: monospace;
    }

    .compose-modal__close {
      width: 32px;
      height: 32px;
      padding: 0;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .compose-modal__close:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .compose-modal__tabs {
      display: flex;
      gap: 2px;
      padding: 0 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      flex-shrink: 0;
    }
    .compose-modal__tab {
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 0.8rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.4);
      background: none;
      border: none;
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }
    .compose-modal__tab:hover { color: rgba(255, 255, 255, 0.7); }
    .compose-modal__tab.active {
      color: #fff;
      border-bottom-color: var(--dodger-blue, #00B1FF);
    }
    .compose-modal__tab-content { display: none; }
    .compose-modal__tab-content.active { display: contents; }

    .compose-modal__body {
      display: grid;
      grid-template-columns: 60% 40%;
      gap: 24px;
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    /* Translations panel */
    .compose-translations {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .compose-translations__controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .compose-translations__lang-select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 0.85rem;
    }
    .compose-translations__lang-select option { background: #1a1a1a; }
    .compose-translations__generate {
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 0.8rem;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid rgba(0, 177, 255, 0.3);
      background: rgba(0, 177, 255, 0.1);
      color: #00B1FF;
      cursor: pointer;
      transition: all 0.15s;
    }
    .compose-translations__generate:hover { background: rgba(0, 177, 255, 0.2); }
    .compose-translations__generate:disabled { opacity: 0.4; cursor: not-allowed; }
    .compose-translations__status {
      display: flex;
      gap: 8px;
      font-size: 0.75rem;
      flex-wrap: wrap;
    }
    .compose-translations__status-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .compose-translations__status-badge--done {
      background: rgba(0, 255, 188, 0.15);
      color: #00FFBC;
    }
    .compose-translations__status-badge--missing {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.3);
    }
    .compose-translations__fields {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .compose-modal__form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .compose-form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .compose-form-group label {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .compose-form-group input,
    .compose-form-group textarea,
    .compose-form-group select {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #fff;
      font-family: var(--font-family, 'Poppins', sans-serif);
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .compose-form-group input:focus,
    .compose-form-group textarea:focus,
    .compose-form-group select:focus {
      outline: none;
      border-color: var(--bright-turquoise, #00FFBC);
      background: rgba(255, 255, 255, 0.08);
    }

    .compose-form-group textarea {
      resize: vertical;
      font-family: var(--font-family, 'Poppins', sans-serif);
    }

    .compose-form-group select option {
      background: #1a1a1a;
      color: #fff;
    }

    .compose-form-divider {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: rgba(255, 255, 255, 0.35);
      padding: 16px 0 6px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      margin-top: 8px;
    }

    .compose-media-preview {
      min-height: 0;
    }

    .compose-form-field-reset {
      width: 24px;
      height: 24px;
      padding: 0;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: #fff;
      font-size: 0.7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .compose-form-field-reset:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .compose-form-fields {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .compose-form-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .compose-form-row .compose-form-group {
      flex: 1;
    }

    .compose-form-row .compose-form-field-reset {
      margin-top: 26px;
    }

    .compose-form-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .compose-form-option {
      display: flex;
      gap: 8px;
    }

    .compose-form-option input {
      flex: 1;
    }

    .compose-form-option button {
      width: 28px;
      height: 28px;
      padding: 0;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .compose-form-option button:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .compose-modal__preview {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .compose-modal__preview-card {
      aspect-ratio: 16 / 9;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      overflow: hidden;
    }

    .compose-modal__preview-card.dark {
      background: #1B2F3C;
      color: #fff;
    }

    .compose-modal__preview-card.light {
      background: #F5F5F0;
      color: #1B2F3C;
    }

    .compose-modal__preview-card.gradient {
      background: linear-gradient(135deg, #1B2F3C, #0a1520);
      color: #fff;
    }

    .compose-modal__preview-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .compose-modal__preview-subtitle {
      font-size: 0.85rem;
      opacity: 0.7;
      margin-bottom: 12px;
    }

    .compose-modal__preview-body {
      font-size: 0.75rem;
      opacity: 0.6;
      max-height: 100px;
      overflow: hidden;
    }

    .compose-modal__footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: rgba(255, 255, 255, 0.02);
    }

    /* ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
    .compose-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: rgba(0, 255, 188, 0.9);
      color: #1B2F3C;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 2000;
    }

    .compose-toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* ‚îÄ‚îÄ‚îÄ Drop indicator ‚îÄ‚îÄ‚îÄ */
    .compose-drop-indicator {
      height: 2px;
      background: var(--bright-turquoise, #00FFBC);
      margin: 2px 0;
      border-radius: 1px;
      display: none;
    }

    .compose-drop-indicator.show {
      display: block;
    }

    /* ‚îÄ‚îÄ‚îÄ Loading state ‚îÄ‚îÄ‚îÄ */
    .compose-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      opacity: 0.6;
    }

    .compose-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--bright-turquoise, #00FFBC);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ‚îÄ‚îÄ‚îÄ Scrollbar styling ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 1024px) {
      .compose-main {
        flex-direction: column;
      }

      .compose-library,
      .compose-builder {
        width: 100%;
        height: 50%;
      }

      .compose-library {
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .compose-modal__body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="compose-container">
    <!-- App Nav -->
    <nav class="app-nav">
      <div class="app-nav__logo"><img src="assets/AIA_Logo_White.svg" alt="AIA"></div>
      <ul class="app-nav__links">
        <li><a href="presenter.html">Dashboard</a></li>
        <li><a href="compose.html" class="active">Courses</a></li>
        <li><a href="manage.html">Sessions</a></li>
      </ul>
    </nav>
    <!-- Top Bar -->
    <div class="compose-top-bar">
      <div class="compose-top-bar__left"></div>
      <div class="compose-top-bar__center">
        <input type="text" class="compose-title-input" placeholder="Course title" id="courseTitle" value="">
      </div>
      <div class="compose-top-bar__right">
        <div class="compose-badge">
          <span id="slideCount">0</span>
          <span class="compose-badge__count">slides</span>
        </div>
        <button class="btn btn--primary" id="saveCourseBtn">Save</button>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="compose-main">
      <!-- Left Panel: Slide Library -->
      <div class="compose-library">
        <div class="compose-library__header">
          <div class="compose-library__title">Slide Library</div>
          <div class="compose-library__search">
            <input type="text" placeholder="Search slides..." id="searchInput">
          </div>
        </div>
        <div class="compose-library__content" id="libraryContent">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Right Panel: Course Builder -->
      <div class="compose-builder">
        <div class="compose-builder__header">
          <div class="compose-builder__title">Your Course</div>
          <div class="compose-builder__stats" id="courseStats"></div>
        </div>
        <div class="compose-builder__content" id="courseContent">
          <div class="compose-empty-state">
            <p>Select slides from the library to build your course</p>
          </div>
        </div>
        <div class="compose-builder__footer">
          <div class="compose-footer-actions">
            <div class="compose-new-slide-wrapper">
              <button class="btn btn--primary compose-new-slide-btn" id="newSlideBtn">+ New Slide</button>
              <div class="compose-template-picker" id="templatePicker">
                <div class="compose-template-picker__header">Choose a slide type</div>
                <button class="compose-template-option" data-template="content">
                  <span class="compose-template-option__icon">üìÑ</span>
                  <span class="compose-template-option__info">
                    <strong>Content</strong>
                    <small>Title, body text, optional callout</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="statement">
                  <span class="compose-template-option__icon">üí¨</span>
                  <span class="compose-template-option__info">
                    <strong>Statement</strong>
                    <small>Bold headline with supporting text</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="cover">
                  <span class="compose-template-option__icon">üé¨</span>
                  <span class="compose-template-option__info">
                    <strong>Cover</strong>
                    <small>Title slide with subtitle</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="section">
                  <span class="compose-template-option__icon">üìë</span>
                  <span class="compose-template-option__info">
                    <strong>Section</strong>
                    <small>Section opener with label and title</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="quiz">
                  <span class="compose-template-option__icon">‚ùì</span>
                  <span class="compose-template-option__info">
                    <strong>Quiz</strong>
                    <small>Multiple-choice question with correct answer</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="poll">
                  <span class="compose-template-option__icon">üìä</span>
                  <span class="compose-template-option__info">
                    <strong>Poll</strong>
                    <small>Audience poll with multiple options</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="text-input">
                  <span class="compose-template-option__icon">‚úèÔ∏è</span>
                  <span class="compose-template-option__info">
                    <strong>Text Input</strong>
                    <small>Open-ended audience response</small>
                  </span>
                </button>
                <button class="compose-template-option" data-template="split">
                  <span class="compose-template-option__icon">‚óß</span>
                  <span class="compose-template-option__info">
                    <strong>Split</strong>
                    <small>Content with side media panel</small>
                  </span>
                </button>
              </div>
            </div>
            <button class="btn btn--secondary compose-add-divider" id="addDividerBtn">+ Section Divider</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Slide Editor -->
  <div class="compose-modal" id="editorModal">
    <div class="compose-modal__content">
      <div class="compose-modal__header">
        <div class="compose-modal__title">
          <span class="compose-modal__badge" id="modalBadge"></span>
          <span class="compose-modal__id" id="modalId"></span>
        </div>
        <button class="compose-modal__close" id="modalCloseBtn">‚úï</button>
      </div>
      <div class="compose-modal__tabs">
        <button class="compose-modal__tab active" data-tab="edit" onclick="switchModalTab('edit')">Edit</button>
        <button class="compose-modal__tab" data-tab="translations" onclick="switchModalTab('translations')">Translations</button>
      </div>
      <div class="compose-modal__body">
        <div class="compose-modal__tab-content active" id="tabEdit">
          <div class="compose-modal__form" id="modalForm">
            <!-- Populated by JS -->
          </div>
          <div class="compose-modal__preview">
            <div class="compose-modal__preview-card" id="previewCard">
              <div class="compose-modal__preview-title" id="previewTitle">Title</div>
              <div class="compose-modal__preview-subtitle" id="previewSubtitle"></div>
              <div class="compose-modal__preview-body" id="previewBody"></div>
            </div>
          </div>
        </div>
        <div class="compose-modal__tab-content" id="tabTranslations">
          <div class="compose-translations" id="translationsPanel">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
      <div class="compose-modal__footer">
        <button class="btn btn--secondary" id="resetAllBtn">Reset All</button>
        <button class="btn btn--primary" id="doneBtn">Done</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="compose-toast" id="toast"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script src="slides/section-1-foundation.js"></script>
  <script src="slides/section-2-what-is-ai.js"></script>
  <script src="slides/section-3-ai-risks.js"></script>
  <script src="slides/section-4-how-ai-works.js"></script>
  <script src="slides/section-5-prompting.js"></script>
  <script src="slides/section-6-applying-ai.js"></script>
  <script src="slides/section-7-close.js"></script>
  <script src="slides/all-slides.js"></script>
  <script src="registry/slides.js"></script>
  <script src="registry/courses.js"></script>
  <script src="registry/registry-api.js"></script>

  <script>
    // ============================================
    // Compose Course Page ‚Äî Main Application
    // ============================================

    // State
    let currentUser = null;
    let courseId = null;
    let courseData = {
      title: 'Untitled Course',
      description: '',
      slides: [],
      sections: [],
      language: 'en'
    };
    let slideOverrides = {}; // { slideId: { field: value, ... }, ... }
    let currentEditingSlideId = null;
    let allSlides = [];
    let filteredSlides = [];
    let draggedSlide = null;
    let draggedFrom = null;
    let customSlides = {}; // { customId: { full slide data } } ‚Äî for template-created slides

    // ‚îÄ‚îÄ‚îÄ Slide Templates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SLIDE_TEMPLATES = {
      content: {
        type: 'content',
        theme: 'dark',
        sectionLabel: '',
        title: 'Untitled Slide',
        body: '<p>Add your content here.</p>',
        notes: '',
      },
      statement: {
        type: 'statement',
        theme: 'dark',
        sectionLabel: '',
        title: 'Your headline goes here',
        body: '<p>Supporting text that expands on the statement above.</p>',
        notes: '',
      },
      cover: {
        type: 'cover',
        theme: 'gradient',
        title: 'Presentation Title',
        subtitle: 'A subtitle that sets the scene',
        notes: '',
      },
      section: {
        type: 'section',
        theme: 'gradient',
        sectionLabel: 'SECTION',
        title: 'Section Title',
        subtitle: 'Brief description of this section',
        notes: '',
      },
      quiz: {
        type: 'quiz',
        theme: 'dark',
        sectionLabel: '',
        title: 'Knowledge Check',
        quiz: {
          question: 'What is the correct answer?',
          options: ['Option A', 'Option B', 'Option C', 'Option D'],
          correct: 0,
        },
        notes: '',
      },
      poll: {
        type: 'poll',
        theme: 'dark',
        sectionLabel: '',
        title: 'Audience Poll',
        poll: {
          question: 'What do you think?',
          options: ['Option 1', 'Option 2', 'Option 3', 'Option 4'],
        },
        notes: '',
      },
      'text-input': {
        type: 'text-input',
        theme: 'dark',
        sectionLabel: '',
        title: 'Your Turn',
        textInput: {
          prompt: 'Share your thoughts on this topic',
          placeholder: 'Type your answer...',
        },
        notes: '',
      },
      split: {
        type: 'split',
        theme: 'light',
        sectionLabel: '',
        title: 'Split Layout',
        body: '<p>Content on the left side, with a media panel on the right.</p>',
        notes: '',
      },
    };

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
      try {
        PrimerAuth.init();
        const session = await PrimerAuth.requirePresenter('/');
        if (!session) return;

        currentUser = await PrimerAuth.getProfile();

        // Load URL parameters
        const params = new URLSearchParams(window.location.search);
        const idParam = params.get('id');
        const duplicateParam = params.get('duplicate');

        // Load course data if editing or duplicating
        if (idParam) {
          await loadCourse(idParam);
        } else if (duplicateParam) {
          await loadCourseForDuplicate(duplicateParam);
        }

        // Build slide library from registry
        buildSlideLibrary();

        // Render UI
        renderLibrary();
        renderCourse();
        updateStats();

        // Setup event listeners
        setupEventListeners();
      } catch (error) {
        console.error('Init failed:', error);
        showToast('Failed to load. Please refresh.', 3000);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Load Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCourse(id) {
      try {
        const serverUrl = (typeof CONFIG !== 'undefined' && CONFIG.SERVER_URL) || '';
        if (!serverUrl) {
          console.warn('No server URL configured');
          return;
        }

        const response = await fetch(`${serverUrl}/api/courses/${id}`, {
          headers: {
            'Authorization': `Bearer ${currentUser.id}`
          }
        });

        if (!response.ok) throw new Error('Failed to load course');

        const data = await response.json();
        courseId = data.id;
        courseData = data;

        // Parse overrides and restore custom slides from course data
        slideOverrides = {};
        customSlides = {};
        (courseData.slides || []).forEach(slide => {
          if (typeof slide === 'object' && slide.id) {
            const { id, _isCustom, ...overrides } = slide;
            slideOverrides[id] = overrides;

            // Restore custom (template-created) slides that aren't in the registry
            const isInRegistry = typeof SLIDE_REGISTRY !== 'undefined' && SLIDE_REGISTRY[id];
            if (_isCustom || id.startsWith('custom-') || !isInRegistry) {
              customSlides[id] = { ...overrides };
            }
          }
        });

        document.getElementById('courseTitle').value = courseData.title || '';
      } catch (error) {
        console.error('Failed to load course:', error);
        showToast('Could not load course', 3000);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Load for Duplicate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCourseForDuplicate(sourceId) {
      try {
        const serverUrl = (typeof CONFIG !== 'undefined' && CONFIG.SERVER_URL) || '';
        let sourceCourse = null;

        // Try to load from API first (for UUIDs)
        if (sourceId.includes('-')) {
          try {
            const response = await fetch(`${serverUrl}/api/courses/${sourceId}`, {
              headers: {
                'Authorization': `Bearer ${currentUser.id}`
              }
            });
            if (response.ok) {
              sourceCourse = await response.json();
            }
          } catch (e) {
            // Fall through to check registry
          }
        }

        // If not found or is a preset ID, check COURSE_DEFINITIONS
        if (!sourceCourse && typeof COURSE_DEFINITIONS !== 'undefined') {
          if (COURSE_DEFINITIONS[sourceId]) {
            const definition = COURSE_DEFINITIONS[sourceId];
            sourceCourse = {
              title: definition.title,
              description: definition.description,
              slides: definition.slides.map(id => id)
            };
          }
        }

        if (!sourceCourse) {
          console.warn('Source course not found:', sourceId);
          return;
        }

        // Copy slides (don't copy ID so it creates a new course)
        courseData.slides = sourceCourse.slides || [];
        courseData.sections = sourceCourse.sections || [];
        courseData.title = sourceCourse.title ? `${sourceCourse.title} (copy)` : 'Untitled Course';
        courseData.description = sourceCourse.description || '';

        document.getElementById('courseTitle').value = courseData.title;
      } catch (error) {
        console.error('Failed to load source course:', error);
        showToast('Could not load source course', 3000);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Build Slide Library ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildSlideLibrary() {
      if (typeof SLIDE_REGISTRY === 'undefined') {
        console.error('SLIDE_REGISTRY not available');
        return;
      }

      allSlides = Object.entries(SLIDE_REGISTRY).map(([id, slide]) => ({
        id,
        ...slide
      }));

      filteredSlides = allSlides;
    }

    // ‚îÄ‚îÄ‚îÄ Get Slide from Registry or Custom ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getSlide(slideId) {
      // Check custom slides first (template-created)
      if (customSlides[slideId]) {
        return { id: slideId, ...customSlides[slideId] };
      }
      return allSlides.find(s => s.id === slideId);
    }

    // ‚îÄ‚îÄ‚îÄ Check if Slide in Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function isSlideInCourse(slideId) {
      return courseData.slides.some(s => {
        const id = typeof s === 'string' ? s : s.id;
        return id === slideId;
      });
    }

    // ‚îÄ‚îÄ‚îÄ Toggle Slide in Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleSlideInCourse(slideId) {
      if (isSlideInCourse(slideId)) {
        removeSlideFromCourse(slideId);
      } else {
        addSlideToCourse(slideId);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Add Slide to Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addSlideToCourse(slideId) {
      if (!isSlideInCourse(slideId)) {
        courseData.slides.push(slideId);
        renderCourse();
        updateStats();
      }
    }

    // ‚îÄ‚îÄ‚îÄ Remove Slide from Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function removeSlideFromCourse(slideId) {
      courseData.slides = courseData.slides.filter(s => {
        const id = typeof s === 'string' ? s : s.id;
        return id !== slideId;
      });
      // Clean up custom slide data
      if (customSlides[slideId]) {
        delete customSlides[slideId];
      }
      if (slideOverrides[slideId]) {
        delete slideOverrides[slideId];
      }
      renderCourse();
      updateStats();
    }

    // ‚îÄ‚îÄ‚îÄ Render Library ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderLibrary() {
      const libraryContent = document.getElementById('libraryContent');
      libraryContent.innerHTML = '';

      if (typeof COURSE_DEFINITIONS === 'undefined' || !COURSE_DEFINITIONS['ai-primer-full']) {
        libraryContent.innerHTML = '<div class="compose-empty-state"><p>No slide library available</p></div>';
        return;
      }

      const defaultCourse = COURSE_DEFINITIONS['ai-primer-full'];
      const sections = defaultCourse.sections || [];

      sections.forEach(section => {
        const sectionId = section.prefix;
        const sectionSlides = filteredSlides.filter(s => s.id.startsWith(section.prefix));
        const selectedCount = sectionSlides.filter(s => isSlideInCourse(s.id)).length;

        const sectionEl = document.createElement('div');
        sectionEl.className = 'compose-section';

        const headerEl = document.createElement('div');
        headerEl.className = 'compose-section__header';
        headerEl.innerHTML = `
          <div class="compose-section__title">
            <span class="compose-section__toggle open">‚ñ∂</span>
            <span>${section.label}</span>
          </div>
          <div class="compose-section__count">${selectedCount}/${sectionSlides.length}</div>
        `;

        const slidesContainerEl = document.createElement('div');
        slidesContainerEl.className = 'compose-section__slides open';

        sectionSlides.forEach(slide => {
          const isSelected = isSlideInCourse(slide.id);
          const slideEl = document.createElement('label');
          slideEl.className = 'compose-slide-row';

          slideEl.innerHTML = `
            <input type="checkbox" class="compose-slide-row__checkbox" ${isSelected ? 'checked' : ''}>
            <span class="compose-slide-row__title">${slide.title || 'Untitled'}</span>
            <span class="compose-slide-row__badge ${(slide.type || 'content').toLowerCase()}">${(slide.type || 'content').toUpperCase()}</span>
          `;

          slideEl.addEventListener('change', (e) => {
            if (e.target.matches('.compose-slide-row__checkbox')) {
              toggleSlideInCourse(slide.id);
            }
          });

          slidesContainerEl.appendChild(slideEl);
        });

        const actionsEl = document.createElement('div');
        actionsEl.className = 'compose-section-actions';
        actionsEl.innerHTML = `
          <button class="btn btn--secondary btn--small">Select All</button>
          <button class="btn btn--secondary btn--small">Deselect All</button>
        `;

        actionsEl.querySelector('button:nth-child(1)').addEventListener('click', () => {
          sectionSlides.forEach(s => {
            if (!isSlideInCourse(s.id)) {
              addSlideToCourse(s.id);
            }
          });
        });

        actionsEl.querySelector('button:nth-child(2)').addEventListener('click', () => {
          sectionSlides.forEach(s => {
            if (isSlideInCourse(s.id)) {
              removeSlideFromCourse(s.id);
            }
          });
        });

        slidesContainerEl.appendChild(actionsEl);

        headerEl.addEventListener('click', () => {
          const isOpen = slidesContainerEl.classList.contains('open');
          if (isOpen) {
            slidesContainerEl.classList.remove('open');
            headerEl.classList.add('compose-section__header--collapsed');
            headerEl.querySelector('.compose-section__toggle').classList.remove('open');
          } else {
            slidesContainerEl.classList.add('open');
            headerEl.classList.remove('compose-section__header--collapsed');
            headerEl.querySelector('.compose-section__toggle').classList.add('open');
          }
        });

        sectionEl.appendChild(headerEl);
        sectionEl.appendChild(slidesContainerEl);
        libraryContent.appendChild(sectionEl);
      });
    }

    // ‚îÄ‚îÄ‚îÄ Render Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderCourse() {
      const courseContent = document.getElementById('courseContent');

      if (courseData.slides.length === 0) {
        courseContent.innerHTML = '<div class="compose-empty-state"><p>Select slides from the library to build your course</p></div>';
        return;
      }

      const listEl = document.createElement('div');
      listEl.className = 'compose-course-list';
      listEl.id = 'courseList';

      courseData.slides.forEach((slideRef, index) => {
        const slideId = typeof slideRef === 'string' ? slideRef : slideRef.id;
        const slide = getSlide(slideId);
        if (!slide) return;

        const hasOverrides = slideOverrides[slideId] && Object.keys(slideOverrides[slideId]).length > 0;

        const rowEl = document.createElement('div');
        rowEl.className = 'compose-course-slide';
        rowEl.draggable = true;
        rowEl.dataset.slideId = slideId;
        rowEl.dataset.index = index;

        const isCustom = !!customSlides[slideId];
        // For custom slides, use override title if set
        const displayTitle = (hasOverrides && slideOverrides[slideId]?.title) || slide.title || 'Untitled';

        rowEl.innerHTML = `
          <div class="compose-course-slide__drag-handle">‚ãÆ‚ãÆ</div>
          <div class="compose-course-slide__number">${index + 1}</div>
          <div class="compose-course-slide__title">${displayTitle}</div>
          <div class="compose-course-slide__badge ${(slide.type || 'content').toLowerCase()}">${(slide.type || 'content').toUpperCase()}</div>
          ${isCustom ? '<div class="compose-course-slide__custom-badge">CUSTOM</div>' : ''}
          ${hasOverrides && !isCustom ? '<div class="compose-course-slide__edited"></div>' : ''}
          <div class="compose-course-slide__actions">
            <button class="compose-course-slide__btn" title="Edit">‚úé</button>
            <button class="compose-course-slide__btn" title="Remove">‚úï</button>
          </div>
        `;

        // Edit button
        rowEl.querySelector('.compose-course-slide__btn:nth-child(1)').addEventListener('click', (e) => {
          e.stopPropagation();
          openSlideEditor(slideId);
        });

        // Remove button
        rowEl.querySelector('.compose-course-slide__btn:nth-child(2)').addEventListener('click', (e) => {
          e.stopPropagation();
          removeSlideFromCourse(slideId);
        });

        // Drag handlers
        rowEl.addEventListener('dragstart', (e) => {
          draggedSlide = slideId;
          draggedFrom = index;
          rowEl.classList.add('dragging');
        });

        rowEl.addEventListener('dragend', () => {
          rowEl.classList.remove('dragging');
          draggedSlide = null;
          draggedFrom = null;
          document.querySelectorAll('.compose-drop-indicator').forEach(el => {
            el.classList.remove('show');
          });
        });

        rowEl.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (draggedSlide && draggedSlide !== slideId) {
            rowEl.classList.add('drag-over');
          }
        });

        rowEl.addEventListener('dragleave', () => {
          rowEl.classList.remove('drag-over');
        });

        rowEl.addEventListener('drop', (e) => {
          e.preventDefault();
          rowEl.classList.remove('drag-over');
          if (draggedSlide && draggedSlide !== slideId && draggedFrom !== null) {
            const newIndex = index;
            const slides = [...courseData.slides];
            const draggedItem = slides[draggedFrom];
            slides.splice(draggedFrom, 1);
            const insertIndex = draggedFrom < newIndex ? newIndex - 1 : newIndex;
            slides.splice(insertIndex, 0, draggedItem);
            courseData.slides = slides;
            renderCourse();
            updateStats();
          }
        });

        listEl.appendChild(rowEl);
      });

      courseContent.innerHTML = '';
      courseContent.appendChild(listEl);
    }

    // ‚îÄ‚îÄ‚îÄ Update Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateStats() {
      const count = courseData.slides.length;
      const duration = Math.ceil(count * 45 / 60); // ~45 seconds per slide
      document.getElementById('slideCount').textContent = count;
      document.getElementById('courseStats').textContent = `${count} slide${count === 1 ? '' : 's'} ¬∑ ~${duration} min`;
    }

    // ‚îÄ‚îÄ‚îÄ Open Slide Editor Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openSlideEditor(slideId) {
      currentEditingSlideId = slideId;
      const slide = getSlide(slideId);
      if (!slide) return;

      const overrides = slideOverrides[slideId] || {};

      // Set modal header
      document.getElementById('modalBadge').textContent = (slide.type || 'content').toUpperCase();
      document.getElementById('modalId').textContent = slideId;

      // Clear and build form
      const form = document.getElementById('modalForm');
      form.innerHTML = '';

      // Title
      form.appendChild(createFormGroup('Title', 'title', slide.title || '', overrides.title));

      // Subtitle
      form.appendChild(createFormGroup('Subtitle', 'subtitle', slide.subtitle || '', overrides.subtitle));

      // Theme
      const themeOptions = [
        { value: 'dark', label: 'Dark' },
        { value: 'light', label: 'Light' },
        { value: 'gradient', label: 'Gradient' },
      ];
      const themeGroup = createFormGroup('Theme', 'theme', '', overrides.theme || slide.theme || 'dark', themeOptions);
      form.appendChild(themeGroup);

      // Speaker Notes
      form.appendChild(createFormGroup('Speaker Notes', 'notes', slide.notes || '', overrides.notes, false, true));

      // Type-specific fields
      const slideType = slide.type || 'content';

      if (['content', 'statement', 'split'].includes(slideType)) {
        form.appendChild(createFormGroup('Body', 'body', slide.body || '', overrides.body, false, true));
        form.appendChild(createFormGroup('Badge', 'badge', slide.badge || '', overrides.badge));
      }

      if (slideType === 'quiz' && slide.quiz) {
        form.appendChild(createFormGroup('Question', 'quiz.question', slide.quiz.question || '', overrides['quiz.question']));
        const options = slide.quiz.options || ['', '', '', ''];
        for (let i = 0; i < options.length; i++) {
          const key = `quiz.option${i}`;
          form.appendChild(createFormGroup(`Option ${String.fromCharCode(65 + i)}`, key, options[i] || '', overrides[key]));
        }
        const correctOptions = options.map((_, i) => ({
          value: String(i),
          label: `${String.fromCharCode(65 + i)} ‚Äî ${options[i] || `Option ${i + 1}`}`,
        }));
        form.appendChild(createFormGroup('Correct Answer', 'quiz.correct', '', String(overrides['quiz.correct'] ?? slide.quiz.correct ?? 0), correctOptions));
      }

      if (slideType === 'poll' && slide.poll) {
        form.appendChild(createFormGroup('Question', 'poll.question', slide.poll.question || '', overrides['poll.question']));
        const options = slide.poll.options || [];
        for (let i = 0; i < options.length; i++) {
          const key = `poll.option${i}`;
          form.appendChild(createFormGroup(`Option ${i + 1}`, key, options[i] || '', overrides[key]));
        }
      }

      if (slideType === 'text-input' && slide.textInput) {
        form.appendChild(createFormGroup('Prompt', 'textInput.prompt', slide.textInput.prompt || '', overrides['textInput.prompt']));
        form.appendChild(createFormGroup('Placeholder', 'textInput.placeholder', slide.textInput.placeholder || '', overrides['textInput.placeholder']));
      }

      // ‚îÄ‚îÄ‚îÄ Media Fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const mediaDivider = document.createElement('div');
      mediaDivider.className = 'compose-form-divider';
      mediaDivider.textContent = 'Media';
      form.appendChild(mediaDivider);

      const existingMedia = slide.media || {};
      const mediaTypeOptions = [
        { value: '', label: 'None' },
        { value: 'image', label: 'Image' },
        { value: 'video', label: 'Video' },
        { value: 'embed', label: 'Embed / iframe' },
      ];
      form.appendChild(createFormGroup('Media Type', 'media.type', '', overrides['media.type'] || existingMedia.type || '', mediaTypeOptions));
      form.appendChild(createFormGroup('URL', 'media.src', existingMedia.src || '', overrides['media.src']));
      form.appendChild(createFormGroup('Alt Text', 'media.alt', existingMedia.alt || '', overrides['media.alt']));

      const positionOptions = [
        { value: '', label: 'Default' },
        { value: 'split', label: 'Split (right side)' },
        { value: 'background', label: 'Background' },
      ];
      form.appendChild(createFormGroup('Position', 'media.position', '', overrides['media.position'] || existingMedia.position || '', positionOptions));

      const fitOptions = [
        { value: '', label: 'Default' },
        { value: 'cover', label: 'Cover (fill, crop)' },
        { value: 'contain', label: 'Contain (full visible)' },
      ];
      form.appendChild(createFormGroup('Fit', 'media.fit', '', overrides['media.fit'] || existingMedia.fit || '', fitOptions));

      // Media preview
      const mediaPreviewEl = document.createElement('div');
      mediaPreviewEl.className = 'compose-media-preview';
      mediaPreviewEl.id = 'mediaPreview';
      form.appendChild(mediaPreviewEl);
      updateMediaPreview();

      // Update preview
      updatePreview();

      // Show modal
      document.getElementById('editorModal').classList.add('open');

      // Setup modal controls
      document.getElementById('modalCloseBtn').onclick = closeSlideEditor;
      document.getElementById('doneBtn').onclick = closeSlideEditor;
      document.getElementById('resetAllBtn').onclick = resetAllOverrides;
    }

    // ‚îÄ‚îÄ‚îÄ Create Form Group ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function createFormGroup(label, key, baseValue, overrideValue, selectOptions = null, isTextarea = false) {
      const groupEl = document.createElement('div');
      groupEl.className = 'compose-form-row';

      const formGroup = document.createElement('div');
      formGroup.className = 'compose-form-group';

      const labelEl = document.createElement('label');
      labelEl.textContent = label;
      formGroup.appendChild(labelEl);

      let inputEl;
      if (selectOptions) {
        inputEl = document.createElement('select');
        if (Array.isArray(selectOptions)) {
          inputEl.innerHTML = selectOptions.map(o =>
            `<option value="${o.value}">${o.label}</option>`
          ).join('');
        } else {
          // Legacy boolean true ‚Äî default to theme options
          inputEl.innerHTML = '<option value="dark">Dark</option><option value="light">Light</option><option value="gradient">Gradient</option>';
        }
      } else if (isTextarea) {
        inputEl = document.createElement('textarea');
        inputEl.rows = key === 'notes' ? 4 : 8;
      } else {
        inputEl = document.createElement('input');
        inputEl.type = 'text';
      }

      inputEl.dataset.key = key;
      inputEl.placeholder = baseValue ? `Default: ${baseValue.substring(0, 30)}...` : '';
      inputEl.value = overrideValue || '';

      inputEl.addEventListener('input', () => {
        if (!slideOverrides[currentEditingSlideId]) {
          slideOverrides[currentEditingSlideId] = {};
        }
        if (inputEl.value !== '') {
          slideOverrides[currentEditingSlideId][key] = inputEl.value;
        } else {
          delete slideOverrides[currentEditingSlideId][key];
        }
        // Sync custom slide data for template-created slides
        if (customSlides[currentEditingSlideId]) {
          if (key.includes('.')) {
            const [parent, child] = key.split('.', 2);
            if (!customSlides[currentEditingSlideId][parent]) customSlides[currentEditingSlideId][parent] = {};
            const optMatch = child.match(/^option(\d+)$/);
            if (optMatch) {
              if (!customSlides[currentEditingSlideId][parent].options) customSlides[currentEditingSlideId][parent].options = [];
              customSlides[currentEditingSlideId][parent].options[parseInt(optMatch[1])] = inputEl.value;
            } else {
              customSlides[currentEditingSlideId][parent][child] = inputEl.value;
            }
          } else {
            customSlides[currentEditingSlideId][key] = inputEl.value;
          }
        }
        updatePreview();
        if (key.startsWith('media.')) updateMediaPreview();
      });

      // For select elements, also listen to 'change' (not just input)
      if (selectOptions) {
        inputEl.addEventListener('change', () => {
          inputEl.dispatchEvent(new Event('input'));
        });
      }

      formGroup.appendChild(inputEl);
      groupEl.appendChild(formGroup);

      const resetBtn = document.createElement('button');
      resetBtn.className = 'compose-form-field-reset';
      resetBtn.textContent = '‚Ü©';
      resetBtn.type = 'button';
      resetBtn.addEventListener('click', () => {
        inputEl.value = '';
        if (slideOverrides[currentEditingSlideId]) {
          delete slideOverrides[currentEditingSlideId][key];
        }
        updatePreview();
      });
      groupEl.appendChild(resetBtn);

      return groupEl;
    }

    // ‚îÄ‚îÄ‚îÄ Update Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateMediaPreview() {
      const el = document.getElementById('mediaPreview');
      if (!el || !currentEditingSlideId) return;
      const overrides = slideOverrides[currentEditingSlideId] || {};
      const slide = getSlide(currentEditingSlideId) || {};
      const existingMedia = slide.media || {};
      const mediaType = overrides['media.type'] || existingMedia.type || '';
      const mediaSrc = overrides['media.src'] || existingMedia.src || '';

      if (!mediaType || !mediaSrc) {
        el.innerHTML = '';
        return;
      }

      if (mediaType === 'image') {
        el.innerHTML = `<img src="${mediaSrc}" alt="Preview" style="max-width:100%;max-height:140px;border-radius:6px;margin-top:8px;">`;
      } else if (mediaType === 'video') {
        el.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,177,255,0.1);border-radius:6px;margin-top:8px;font-size:0.8rem;color:#00B1FF;">üé¨ Video: ${mediaSrc.substring(0, 50)}...</div>`;
      } else if (mediaType === 'embed') {
        el.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:10px;background:rgba(0,255,188,0.1);border-radius:6px;margin-top:8px;font-size:0.8rem;color:#00FFBC;">üîó Embed: ${mediaSrc.substring(0, 50)}...</div>`;
      }
    }

    function updatePreview() {
      if (!currentEditingSlideId) return;

      const slide = getSlide(currentEditingSlideId);
      const overrides = slideOverrides[currentEditingSlideId] || {};
      const preview = document.getElementById('previewCard');

      // Apply theme
      const theme = overrides.theme || slide.theme || 'dark';
      preview.className = `compose-modal__preview-card ${theme}`;

      // Get current values from form
      const form = document.getElementById('modalForm');
      const titleInput = form.querySelector('[data-key="title"]');
      const subtitleInput = form.querySelector('[data-key="subtitle"]');
      const bodyInput = form.querySelector('[data-key="body"]');

      const title = titleInput ? titleInput.value || slide.title || 'Title' : slide.title || 'Title';
      const subtitle = subtitleInput ? subtitleInput.value || slide.subtitle || '' : slide.subtitle || '';
      const body = bodyInput ? bodyInput.value || slide.body || '' : slide.body || '';

      document.getElementById('previewTitle').textContent = title;
      document.getElementById('previewSubtitle').textContent = subtitle;
      document.getElementById('previewBody').innerHTML = body.substring(0, 150);
    }

    // ‚îÄ‚îÄ‚îÄ Reset All Overrides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function resetAllOverrides() {
      if (!currentEditingSlideId) return;
      slideOverrides[currentEditingSlideId] = {};
      openSlideEditor(currentEditingSlideId);
    }

    // ‚îÄ‚îÄ‚îÄ Modal Tab Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchModalTab(tabName) {
      document.querySelectorAll('.compose-modal__tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.compose-modal__tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.compose-modal__tab[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName === 'edit' ? 'tabEdit' : 'tabTranslations').classList.add('active');
      if (tabName === 'translations') renderTranslationsPanel();
    }

    // ‚îÄ‚îÄ‚îÄ Translations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SUPPORTED_LANGUAGES = {
      en: 'English', fr: 'Fran√ßais', de: 'Deutsch', es: 'Espa√±ol',
      it: 'Italiano', pt: 'Portugu√™s', nl: 'Nederlands', ja: 'Êó•Êú¨Ë™û',
      zh: '‰∏≠Êñá', ar: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
    };

    // Course-level translations store
    if (!courseData.translations) courseData.translations = {};

    function renderTranslationsPanel() {
      const panel = document.getElementById('translationsPanel');
      if (!panel || !currentEditingSlideId) return;

      const slideId = currentEditingSlideId;
      const slide = getSlide(slideId);
      const overrides = slideOverrides[slideId] || {};
      const slideTrans = courseData.translations[slideId] || {};

      // Build status badges
      const statusHtml = Object.entries(SUPPORTED_LANGUAGES).map(([code, name]) => {
        if (code === 'en') return ''; // English is the base
        const has = slideTrans[code] && Object.keys(slideTrans[code]).length > 0;
        return `<span class="compose-translations__status-badge compose-translations__status-badge--${has ? 'done' : 'missing'}">${has ? '‚úì' : '‚úó'} ${code.toUpperCase()}</span>`;
      }).join('');

      panel.innerHTML = `
        <div class="compose-translations__controls">
          <select class="compose-translations__lang-select" id="transLangSelect">
            ${Object.entries(SUPPORTED_LANGUAGES).filter(([c]) => c !== 'en').map(([code, name]) =>
              `<option value="${code}">${name}</option>`
            ).join('')}
          </select>
          <button class="compose-translations__generate" id="transGenerateBtn" onclick="generateTranslation()">Generate with AI</button>
          <span id="transStatus" style="font-size:0.8rem;opacity:0.6;"></span>
        </div>
        <div class="compose-translations__status">${statusHtml}</div>
        <div class="compose-form-divider">Slide Language Override</div>
        <div class="compose-form-row" style="margin-bottom:12px;">
          <div class="compose-form-group">
            <label>Render this slide in</label>
            <select id="slideLanguageOverride" style="padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:#fff;font-family:var(--font-family);font-size:0.85rem;">
              <option value="">Session default</option>
              ${Object.entries(SUPPORTED_LANGUAGES).map(([code, name]) =>
                `<option value="${code}" ${(overrides.language || '') === code ? 'selected' : ''}>${name}</option>`
              ).join('')}
            </select>
          </div>
        </div>
        <div class="compose-form-divider">Translation Fields</div>
        <div class="compose-translations__fields" id="transFields">
          <!-- Populated when language is selected -->
        </div>
      `;

      // Wire language override
      document.getElementById('slideLanguageOverride').addEventListener('change', function() {
        if (!slideOverrides[slideId]) slideOverrides[slideId] = {};
        if (this.value) {
          slideOverrides[slideId].language = this.value;
        } else {
          delete slideOverrides[slideId].language;
        }
        if (customSlides[slideId]) {
          if (this.value) customSlides[slideId].language = this.value;
          else delete customSlides[slideId].language;
        }
      });

      // Wire language select
      document.getElementById('transLangSelect').addEventListener('change', () => renderTranslationFields());
      renderTranslationFields();
    }

    function renderTranslationFields() {
      const container = document.getElementById('transFields');
      if (!container || !currentEditingSlideId) return;

      const slideId = currentEditingSlideId;
      const lang = document.getElementById('transLangSelect').value;
      const slide = getSlide(slideId);
      const overrides = slideOverrides[slideId] || {};
      const trans = (courseData.translations[slideId] && courseData.translations[slideId][lang]) || {};

      // Determine which fields to show based on slide content
      const fields = [];
      if (slide.title) fields.push({ key: 'title', label: 'Title', value: trans.title || '', base: overrides.title || slide.title });
      if (slide.subtitle) fields.push({ key: 'subtitle', label: 'Subtitle', value: trans.subtitle || '', base: overrides.subtitle || slide.subtitle });
      if (slide.body) fields.push({ key: 'body', label: 'Body', value: trans.body || '', base: overrides.body || slide.body, textarea: true });
      if (slide.notes) fields.push({ key: 'notes', label: 'Speaker Notes', value: trans.notes || '', base: overrides.notes || slide.notes, textarea: true });
      if (slide.quiz) {
        fields.push({ key: 'quiz.question', label: 'Quiz Question', value: trans['quiz.question'] || '', base: slide.quiz.question });
        (slide.quiz.options || []).forEach((opt, i) => {
          fields.push({ key: `quiz.option${i}`, label: `Option ${String.fromCharCode(65 + i)}`, value: trans[`quiz.option${i}`] || '', base: opt });
        });
      }
      if (slide.poll) {
        fields.push({ key: 'poll.question', label: 'Poll Question', value: trans['poll.question'] || '', base: slide.poll.question });
        (slide.poll.options || []).forEach((opt, i) => {
          fields.push({ key: `poll.option${i}`, label: `Option ${i + 1}`, value: trans[`poll.option${i}`] || '', base: opt });
        });
      }
      if (slide.textInput) {
        fields.push({ key: 'textInput.prompt', label: 'Prompt', value: trans['textInput.prompt'] || '', base: slide.textInput.prompt });
        fields.push({ key: 'textInput.placeholder', label: 'Placeholder', value: trans['textInput.placeholder'] || '', base: slide.textInput.placeholder });
      }

      container.innerHTML = fields.map(f => `
        <div class="compose-form-group">
          <label>${f.label} <span style="opacity:0.3;font-size:0.7rem;margin-left:4px;">EN: ${(f.base || '').substring(0, 40).replace(/</g, '&lt;')}${(f.base || '').length > 40 ? '...' : ''}</span></label>
          ${f.textarea
            ? `<textarea data-trans-key="${f.key}" rows="4" placeholder="Enter ${SUPPORTED_LANGUAGES[lang]} translation..." style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:#fff;font-family:var(--font-family);font-size:0.85rem;resize:vertical;">${f.value}</textarea>`
            : `<input type="text" data-trans-key="${f.key}" value="${f.value.replace(/"/g, '&quot;')}" placeholder="Enter ${SUPPORTED_LANGUAGES[lang]} translation..." style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:#fff;font-family:var(--font-family);font-size:0.85rem;">`
          }
        </div>
      `).join('');

      // Wire up change handlers
      container.querySelectorAll('[data-trans-key]').forEach(input => {
        input.addEventListener('input', () => {
          const key = input.dataset.transKey;
          if (!courseData.translations[slideId]) courseData.translations[slideId] = {};
          if (!courseData.translations[slideId][lang]) courseData.translations[slideId][lang] = {};
          if (input.value) {
            courseData.translations[slideId][lang][key] = input.value;
          } else {
            delete courseData.translations[slideId][lang][key];
          }
        });
      });
    }

    async function generateTranslation() {
      const slideId = currentEditingSlideId;
      if (!slideId) return;

      const lang = document.getElementById('transLangSelect').value;
      const btn = document.getElementById('transGenerateBtn');
      const status = document.getElementById('transStatus');

      const slide = getSlide(slideId);
      const overrides = slideOverrides[slideId] || {};

      // Build content to translate
      const content = {};
      if (slide.title) content.title = overrides.title || slide.title;
      if (slide.subtitle) content.subtitle = overrides.subtitle || slide.subtitle;
      if (slide.body) content.body = overrides.body || slide.body;
      if (slide.notes) content.notes = overrides.notes || slide.notes;
      if (slide.quiz) {
        content['quiz.question'] = slide.quiz.question;
        (slide.quiz.options || []).forEach((opt, i) => { content[`quiz.option${i}`] = opt; });
      }
      if (slide.poll) {
        content['poll.question'] = slide.poll.question;
        (slide.poll.options || []).forEach((opt, i) => { content[`poll.option${i}`] = opt; });
      }
      if (slide.textInput) {
        content['textInput.prompt'] = slide.textInput.prompt;
        content['textInput.placeholder'] = slide.textInput.placeholder;
      }

      btn.disabled = true;
      status.textContent = 'Translating...';

      try {
        const serverUrl = (typeof CONFIG !== 'undefined' && CONFIG.SERVER_URL) || '';
        const res = await fetch(`${serverUrl}/api/translate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, targetLang: lang, sourceLang: 'en' }),
        });

        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        const translated = await res.json();

        if (!courseData.translations[slideId]) courseData.translations[slideId] = {};
        courseData.translations[slideId][lang] = translated;

        status.textContent = '‚úì Done';
        renderTranslationsPanel(); // Refresh to show new translations
      } catch (err) {
        console.error('Translation failed:', err);
        status.textContent = '‚úó Failed ‚Äî enter manually or check API key';
      } finally {
        btn.disabled = false;
      }
    }

    // ‚îÄ‚îÄ‚îÄ Close Slide Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function closeSlideEditor() {
      document.getElementById('editorModal').classList.remove('open');
      // Reset to Edit tab
      switchModalTab('edit');
      currentEditingSlideId = null;
    }

    // ‚îÄ‚îÄ‚îÄ Search Slides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function searchSlides(query) {
      if (!query.trim()) {
        filteredSlides = allSlides;
      } else {
        const q = query.toLowerCase();
        filteredSlides = allSlides.filter(s =>
          (s.title || '').toLowerCase().includes(q)
        );
      }
      renderLibrary();
    }

    // ‚îÄ‚îÄ‚îÄ Save Course ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function saveCourse() {
      try {
        const title = document.getElementById('courseTitle').value.trim();
        if (!title) {
          showToast('Course title is required', 3000);
          return;
        }

        courseData.title = title;

        // Merge slides with overrides
        const slides = courseData.slides.map(slideRef => {
          const slideId = typeof slideRef === 'string' ? slideRef : slideRef.id;
          const overrides = slideOverrides[slideId];
          if (overrides && Object.keys(overrides).length > 0) {
            return { id: slideId, ...overrides };
          }
          return slideId;
        });

        const payload = {
          ...courseData,
          slides,
          presenterId: currentUser.id
        };

        const serverUrl = (typeof CONFIG !== 'undefined' && CONFIG.SERVER_URL) || '';
        if (!serverUrl) {
          showToast('Server not configured', 3000);
          return;
        }

        const method = courseId ? 'PUT' : 'POST';
        const url = courseId ? `${serverUrl}/api/courses/${courseId}` : `${serverUrl}/api/courses`;

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.id}`
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Save failed');

        const saved = await response.json();
        courseId = saved.id;

        showToast('Course saved', 3000);
      } catch (error) {
        console.error('Save failed:', error);
        showToast('Failed to save course', 3000);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Show Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // ‚îÄ‚îÄ‚îÄ Add Slide from Template ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addSlideFromTemplate(templateType) {
      const template = SLIDE_TEMPLATES[templateType];
      if (!template) return;

      // Generate unique custom slide ID
      const customId = `custom-${templateType}-${Date.now()}`;

      // Store full slide data in customSlides (deep copy)
      customSlides[customId] = JSON.parse(JSON.stringify(template));

      // Add to course ‚Äî store all properties as overrides so the server has the full data
      const slideEntry = { id: customId, _isCustom: true, ...JSON.parse(JSON.stringify(template)) };
      courseData.slides.push(slideEntry);

      // Also track in slideOverrides for consistency
      slideOverrides[customId] = JSON.parse(JSON.stringify(template));

      renderCourse();
      updateStats();

      // Close the template picker
      document.getElementById('templatePicker').classList.remove('open');

      // Auto-open editor for the new slide
      openSlideEditor(customId);
    }

    // ‚îÄ‚îÄ‚îÄ Toggle Template Picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleTemplatePicker() {
      const picker = document.getElementById('templatePicker');
      picker.classList.toggle('open');
    }

    // ‚îÄ‚îÄ‚îÄ Setup Event Listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', (e) => {
        searchSlides(e.target.value);
      });

      document.getElementById('saveCourseBtn').addEventListener('click', saveCourse);

      document.getElementById('addDividerBtn').addEventListener('click', () => {
        const label = prompt('Section label:', '');
        if (label !== null) {
          const divider = { type: 'divider', label };
          if (!Array.isArray(courseData.sections)) {
            courseData.sections = [];
          }
          courseData.sections.push({
            label,
            startIndex: courseData.slides.length
          });
          renderCourse();
        }
      });

      // Template picker
      document.getElementById('newSlideBtn').addEventListener('click', toggleTemplatePicker);

      document.querySelectorAll('.compose-template-option').forEach(btn => {
        btn.addEventListener('click', () => {
          addSlideFromTemplate(btn.dataset.template);
        });
      });

      // Close template picker when clicking outside
      document.addEventListener('click', (e) => {
        const picker = document.getElementById('templatePicker');
        const btn = document.getElementById('newSlideBtn');
        if (!picker.contains(e.target) && e.target !== btn) {
          picker.classList.remove('open');
        }
      });

      document.getElementById('modalCloseBtn').addEventListener('click', closeSlideEditor);
    }

    // ‚îÄ‚îÄ‚îÄ Start App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    init();
  </script>
</body>
</html>
